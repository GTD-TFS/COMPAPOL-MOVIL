<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>COMPAPOL ¬∑ iPhone</title>
<style>
  :root{ --bg:#0b1220; --panel:#0f172a; --line:#24324a; --txt:#e5e7eb; --muted:#94a3b8; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444; }
  *{ box-sizing:border-box; }
  body{ margin:0; background:var(--bg); color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
  header{ position:sticky; top:0; z-index:9; background:#111827; border-bottom:1px solid var(--line); padding:8px 10px; display:flex; gap:8px; align-items:center; }
  h1{ margin:0; font-size:14px; font-weight:600; }
  .wrap{ padding:10px; max-width:780px; margin:0 auto; }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .btn{ width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--line); background:#1f2937; color:var(--txt); border-radius:10px; font-size:16px; }
  .btn.w{ width:auto; padding:0 10px; height:36px; }
  textarea{ width:100%; min-height:220px; background:var(--panel); color:var(--txt); border:1px solid var(--line); border-radius:12px; padding:10px; font-size:15px; }
  .status{ font-size:12px; color:var(--muted); min-height:18px; margin:6px 2px 10px; }
  .out{ min-height:160px; background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:10px; }
  .chipbar{ display:flex; gap:6px; overflow-x:auto; padding:6px 0; }
  .chip{ display:inline-flex; align-items:center; gap:6px; padding:4px 6px; background:#182235; border:1px solid var(--line); border-radius:999px; font-size:12px; white-space:nowrap; }
  .chip .ins{ width:24px; height:24px; border-radius:8px; border:1px solid var(--line); background:#22304a; color:var(--txt); display:inline-flex; align-items:center; justify-content:center; font-size:14px; }
  .accordion{ border:1px solid var(--line); border-radius:12px; overflow:hidden; }
  .acc-h{ background:#131c2c; padding:8px 10px; display:flex; align-items:center; justify-content:space-between; font-size:14px; }
  .acc-c{ background:#0f172a; padding:10px; display:none; }
  .acc-c.show{ display:block; }
  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  input[type="text"],input[type="date"]{ width:100%; height:34px; border-radius:8px; border:1px solid var(--line); background:#0b1220; color:var(--txt); padding:0 8px; font-size:14px; }
  .list{ margin-top:8px; display:grid; gap:6px; }
  .rowItem{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 8px; background:#101a2a; border:1px solid var(--line); border-radius:10px; font-size:13px; }
  .muted{ color:var(--muted); font-size:12px; }
</style>
</head>
<body>
<header>
  <h1>COMPAPOL ¬∑ iPhone</h1>
  <div id="live" class="muted"></div>
</header>
<div class="wrap">

  <!-- Botonera compacta -->
  <div class="row" style="margin-bottom:8px;">
    <button id="btnRec" class="btn" title="Grabar (servidor)">üéß</button>
    <button id="btnRecStop" class="btn" title="Parar grabaci√≥n">‚èπÔ∏è</button>
    <label class="btn" title="Subir audio">
      ‚¨ÜÔ∏è <input id="fileAudio" type="file" accept="audio/*" capture="microphone" style="display:none">
    </label>
    <button id="btnClear" class="btn" title="Limpiar">üßπ</button>
    <button id="btnDraft" class="btn" title="Redactar policial">‚öôÔ∏è</button>
    <button id="btnCopy" class="btn" title="Copiar salida">üìã</button>
    <button id="btnDownload" class="btn" title="Descargar JSON">üíæ</button>
  </div>

  <!-- Tira de filiaciones con insertar -->
  <div class="chipbar" id="filiChips"></div>

  <!-- Panel plegable: a√±adir / importar filiaciones -->
  <div class="accordion" style="margin:6px 0 10px;">
    <div class="acc-h">
      <span>Filiaciones ‚ñæ</span>
      <div class="row">
        <label class="btn w" for="fileFili" title="Importar JSON">üì• Importar</label>
        <input id="fileFili" type="file" accept="application/json" style="display:none">
        <button id="btnAddFili" class="btn w" title="Guardar ficha">‚ûï A√±adir</button>
      </div>
    </div>
    <div class="acc-c" id="accBody">
      <div class="grid2">
        <input id="fiNombre" type="text" placeholder="Nombre">
        <input id="fiApellidos" type="text" placeholder="Apellidos (MAY√öSC.)">
        <input id="fiDoc" type="text" placeholder="Documento o indocumentado/a">
        <input id="fiSexo" type="text" placeholder="Sexo (M/F)">
        <input id="fiLugar" type="text" placeholder="Lugar nacimiento">
        <input id="fiFecha" type="date" placeholder="Fecha nac. (YYYY-MM-DD)">
        <input id="fiPadres" type="text" placeholder="Padres">
        <input id="fiDom" type="text" placeholder="Domicilio">
        <input id="fiTel" type="text" placeholder="Tel√©fono">
        <input id="fiAlias" type="text" placeholder="Alias (coma-sep.: conor, mcgregor)">
      </div>
      <div class="muted" style="margin-top:6px;">Las fichas se guardan en este dispositivo.</div>
      <div class="list" id="filiList"></div>
    </div>
  </div>

  <textarea id="txt" placeholder="Dicta o pega aqu√≠ el texto; despu√©s inserta fichas con ‚ûï y pulsa ‚öôÔ∏è para convertir a estilo policial."></textarea>
  <div id="status" class="status"></div>

  <h3 style="margin:10px 0 6px;">Salida</h3>
  <div id="out" class="out"></div>
</div>

<script>
const API_BASE = "https://compa-movil-backend.onrender.com";

// ====== Estado / util ======
const $ = s => document.querySelector(s);
const live = $('#live'), statusEl = $('#status'), txt = $('#txt'), out = $('#out');
function setStatus(s){ statusEl.textContent = s; }
function setLive(s){ live.textContent = s; }

// ====== LocalStorage (objeto con llaves, sin arrays) ======
const LSK = "compapol.fili.map"; // { id: {campos}, ... }

function loadMap(){
  try{ const v = JSON.parse(localStorage.getItem(LSK)||"{}"); return v && typeof v==="object" ? v : {}; }
  catch{ return {}; }
}
function saveMap(m){ localStorage.setItem(LSK, JSON.stringify(m||{})); }
function mapToArray(m){ return Object.entries(m||{}).map(([id,v])=>({id, ...v})); }

// ====== Inserci√≥n de texto en cursor ======
function insertAtCursor(el, text){
  const start = el.selectionStart ?? el.value.length;
  const end = el.selectionEnd ?? el.value.length;
  const before = el.value.slice(0,start);
  const after  = el.value.slice(end);
  el.value = before + text + after;
  const pos = start + text.length;
  el.selectionStart = el.selectionEnd = pos;
  el.focus();
}

// ====== Formato de filiaci√≥n (solo campos presentes) ======
function formatFichaFull(x){
  const nom = (x.nombre||"").trim();
  const ape = (x.apellidos||"").trim();
  if(!nom && !ape) return ""; // necesita al menos nombre/apellidos

  const segs = [];
  segs.push([nom.toUpperCase(), ape.toUpperCase()].filter(Boolean).join(" ").trim());

  // doc / indocumentado/a
  if (x.documentacion && x.documentacion.trim()){
    segs.push(x.documentacion.trim());
  } else {
    segs.push("indocumentado/a");
  }

  // nacido/a en ‚Ä¶ el ‚Ä¶
  const sx = String(x.sexo||"").toUpperCase();
  const nac = sx.startsWith("F") ? "nacida" : sx.startsWith("M") ? "nacido" : "nacido/a";
  const lugar = (x.lugar_nacimiento||"").trim();
  let f = (x.fecha_nacimiento||"").trim();
  if (/^\d{4}-\d{2}-\d{2}$/.test(f)) { const [Y,M,D] = f.split("-"); f = `${D}/${M}/${Y}`; }
  const segNac = [];
  if (lugar) segNac.push(`en ${lugar}`);
  if (f) segNac.push(`el ${f}`);
  if (segNac.length) segs.push(`${nac} ${segNac.join(" ")}`);

  // hijo/a de ‚Ä¶
  if (x.padres && x.padres.trim()){
    const hijo = sx.startsWith("F") ? "hija" : sx.startsWith("M") ? "hijo" : "hijo/a";
    segs.push(`${hijo} de ${x.padres.trim()}`);
  }

  // domicilio ‚Ä¶
  if (x.domicilio && x.domicilio.trim()){
    segs.push(`domicilio en ${x.domicilio.trim()}`);
  }

  // tel√©fono ‚Ä¶
  if (x.telefono && x.telefono.trim()){
    segs.push(`tel√©fono ${x.telefono.trim()}`);
  }

  return segs.join(", ") + ".";
}

// ====== UI: chips + lista y panel plegable ======
const chips = $('#filiChips');
const list  = $('#filiList');
const accBody = $('#accBody');

function aliasLabel(v){
  const a = Array.isArray(v.aliases)? v.aliases[0] : "";
  if (a) return a.length>12 ? a.slice(0,12)+"‚Ä¶" : a;
  const n = (v.nombre||"").trim(); if(!n) return "sin nombre";
  return n.length>12 ? n.slice(0,12)+"‚Ä¶" : n;
}

function rebuildUI(){
  const m = loadMap();
  // chips (compacto)
  chips.innerHTML = "";
  for (const [id,v] of Object.entries(m)){
    const div = document.createElement('div');
    div.className = 'chip';
    const span = document.createElement('span');
    span.textContent = aliasLabel(v);
    const btn = document.createElement('button');
    btn.className = 'ins';
    btn.textContent = '‚ûï';
    btn.title = 'Insertar en el cursor';
    btn.onclick = ()=> {
      const t = formatFichaFull(v);
      if (t) insertAtCursor(txt, t+" ");
    };
    div.appendChild(span);
    div.appendChild(btn);
    chips.appendChild(div);
  }
  // lista completa (en panel)
  list.innerHTML = "";
  for (const [id,v] of Object.entries(m)){
    const row = document.createElement('div');
    row.className = 'rowItem';
    const left = document.createElement('div');
    left.textContent = `${(v.nombre||"").toUpperCase()} ${(v.apellidos||"").toUpperCase()}`.trim() || id;
    const right = document.createElement('div');
    const bIns = document.createElement('button'); bIns.className='btn w'; bIns.textContent='‚ûï Insertar';
    bIns.onclick = ()=>{ const t = formatFichaFull(v); if(t) insertAtCursor(txt, t+" "); };
    right.appendChild(bIns);
    row.appendChild(left); row.appendChild(right);
    list.appendChild(row);
  }
}
rebuildUI();

// ====== Plegar/Desplegar ======
document.querySelector('.acc-h').addEventListener('click', (e)=>{
  if (e.target.id==='btnAddFili' || e.target.htmlFor==='fileFili') return;
  accBody.classList.toggle('show');
});

// ====== A√±adir ficha ======
const fiNombre=$('#fiNombre'), fiApellidos=$('#fiApellidos'), fiDoc=$('#fiDoc'), fiSexo=$('#fiSexo'),
      fiLugar=$('#fiLugar'), fiFecha=$('#fiFecha'), fiPadres=$('#fiPadres'), fiDom=$('#fiDom'), fiTel=$('#fiTel'), fiAlias=$('#fiAlias');

$('#btnAddFili').addEventListener('click', ()=>{
  const id = "P"+Date.now();
  const v = {
    nombre: fiNombre.value||"",
    apellidos: fiApellidos.value||"",
    documentacion: fiDoc.value||"",
    sexo: fiSexo.value||"",
    lugar_nacimiento: fiLugar.value||"",
    fecha_nacimiento: fiFecha.value||"",
    padres: fiPadres.value||"",
    domicilio: fiDom.value||"",
    telefono: fiTel.value||"",
    aliases: (fiAlias.value||"").split(",").map(s=>s.trim()).filter(Boolean)
  };
  const m = loadMap(); m[id]=v; saveMap(m);
  fiNombre.value=fiApellidos.value=fiDoc.value=fiSexo.value=fiLugar.value=fiFecha.value=fiPadres.value=fiDom.value=fiTel.value=fiAlias.value="";
  rebuildUI();
  setStatus("‚úÖ Ficha guardada.");
});

// ====== Importar JSON (objeto con llaves, sin arrays) ======
$('#fileFili').addEventListener('change', async (ev)=>{
  const f = ev.target.files?.[0]; if(!f) return;
  try{
    const txt = await f.text();
    const obj = JSON.parse(txt);
    if (!obj || typeof obj!=="object") throw new Error("El JSON debe ser un objeto { id: {‚Ä¶}, ‚Ä¶ }");
    const m = loadMap();
    for (const [id,val] of Object.entries(obj)){
      if (id==="texto") continue; // por si viene empaquetado
      if (val && typeof val==="object") m[id]=val;
    }
    saveMap(m);
    rebuildUI();
    setStatus("‚úÖ Filiaciones importadas.");
  }catch(e){ setStatus("‚ùå Error al importar: "+(e.message||e)); }
  finally{ ev.target.value=""; }
});

// ====== Descargar JSON { texto, filiaciones:{...} } ======
$('#btnDownload').addEventListener('click', ()=>{
  const payload = {
    texto: txt.value||"",
    filiaciones: loadMap()
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "compapol.json";
  a.click();
  setStatus("üíæ JSON descargado.");
});

// ====== Grabaci√≥n (servidor) iPhone-friendly ======
const btnRec = $('#btnRec'), btnRecStop = $('#btnRecStop'), fileAudio = $('#fileAudio');

let mediaRecorder=null, recChunks=[], recStream=null;
async function startRecording(){
  try{
    recStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    let mime=''; if (window.MediaRecorder && MediaRecorder.isTypeSupported){
      if (MediaRecorder.isTypeSupported('audio/mp4')) mime='audio/mp4';
      else if (MediaRecorder.isTypeSupported('audio/webm')) mime='audio/webm';
    }
    mediaRecorder = mime ? new MediaRecorder(recStream,{mimeType:mime}) : new MediaRecorder(recStream);
    recChunks=[];
    mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size) recChunks.push(e.data); };
    mediaRecorder.onstart = ()=> setStatus('üî¥ Grabando‚Ä¶');
    mediaRecorder.onstop = async ()=>{
      try{
        const type = mediaRecorder.mimeType || (recChunks[0]?.type) || 'audio/mp4';
        const blob = new Blob(recChunks,{type});
        const ext = type.includes('mp4')?'m4a':type.includes('webm')?'webm':type.includes('wav')?'wav':'m4a';
        const file = new File([blob],`grabacion.${ext}`,{type});
        setStatus('‚è≥ Enviando audio‚Ä¶');
        const fd = new FormData(); fd.append('file',file,file.name);
        const r = await fetch(`${API_BASE}/api/whisper`,{method:'POST', body:fd});
        if(!r.ok){ let msg='HTTP '+r.status; try{const j=await r.json(); if(j?.error) msg+=' ¬∑ '+j.error;}catch{} throw new Error(msg); }
        const { text } = await r.json();
        txt.value = (txt.value ? (txt.value.trim()+" ") : "") + (text||"");
        setStatus('‚úÖ Transcripci√≥n lista.');
      }catch(e){ setStatus('‚ùå Error: '+(e.message||e)); }
      finally{ recStream?.getTracks()?.forEach(t=>t.stop()); recStream=null; mediaRecorder=null; recChunks=[]; }
    };
    mediaRecorder.start(1000);
  }catch(err){ setStatus('‚ùå Micr√≥fono no disponible: '+(err.message||err)); }
}
function stopRecording(){ try{ if(mediaRecorder && mediaRecorder.state!=='inactive') mediaRecorder.stop(); }catch{} }

btnRec.addEventListener('click', startRecording);
btnRecStop.addEventListener('click', stopRecording);

// Subir audio manual
fileAudio.addEventListener('change', async ()=>{
  const f = fileAudio.files?.[0]; if(!f) return;
  try{
    setStatus('‚è≥ Transcribiendo‚Ä¶');
    const fd = new FormData(); fd.append('file',f,f.name);
    const r = await fetch(`${API_BASE}/api/whisper`,{method:'POST', body:fd});
    if(!r.ok){ let msg='HTTP '+r.status; try{const j=await r.json(); if(j?.error) msg+=' ¬∑ '+j.error;}catch{} throw new Error(msg); }
    const { text } = await r.json();
    txt.value = (txt.value ? (txt.value.trim()+" ") : "") + (text||"");
    setStatus('‚úÖ Transcripci√≥n lista.');
  }catch(e){ setStatus('‚ùå Error: '+(e.message||e)); }
  finally{ fileAudio.value=''; }
});

// Redactar
$('#btnDraft').addEventListener('click', async ()=>{
  const body = JSON.stringify({ texto: txt.value||"", filiaciones:[], objetos:[], fichas_resueltas:[] });
  try{
    setStatus('‚è≥ Redactando comparecencia‚Ä¶');
    const r = await fetch(`${API_BASE}/api/police-draft`, { method:'POST', headers:{'Content-Type':'application/json'}, body });
    if(!r.ok){ let msg='HTTP '+r.status; try{const j=await r.json(); if(j?.error) msg+=' ¬∑ '+j.error;}catch{} throw new Error(msg); }
    const { html } = await r.json();
    out.innerHTML = html || '';
    setStatus('‚úÖ Listo.');
  }catch(e){ setStatus('‚ùå Error en redacci√≥n: '+(e.message||e)); }
});

// Limpiar, copiar
$('#btnClear').addEventListener('click', ()=>{ txt.value=''; out.innerHTML=''; setStatus('üßπ Limpio.'); });
$('#btnCopy').addEventListener('click', async ()=>{
  try{
    const plain = (out.innerHTML||'').replace(/<p>/g,'\n').replace(/<[^>]+>/g,'').trim();
    await navigator.clipboard.writeText(plain);
    setStatus('üìã Copiado.');
  }catch{ setStatus('‚ö†Ô∏è No se pudo copiar.'); }
});

// Ping
(async()=>{ try{ const r=await fetch(`${API_BASE}/healthz`); setLive(r.ok?'üü¢':'üü†'); }catch{ setLive('üü†'); }})();
</script>
</body>
</html>
