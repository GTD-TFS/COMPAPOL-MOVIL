<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DILIPOL · Inicio</title>
  <link rel="stylesheet" href="css/styles.css" />

 <style>
  /* Oculta la navegación superior SOLO en index */
  .top-nav { display: none !important; }

  /* Barra de acciones bajo “DILIPOL” */
  .expediente-bar { margin-top: 10px; }
  .expediente-row {
    display: flex; gap: 10px; flex-wrap: wrap; align-items: center; padding-left: 50px;
  }

  /* Botones superiores (Iniciar/Abrir, Guardar, Salir) */
  .exp-btn {
    display: inline-block; min-width: 220px; text-align: center;
    padding: 12px 16px; border-radius: 12px;
    border: 1px solid rgba(15,23,42,.15);
    cursor: pointer; font-weight: 700; letter-spacing: .2px;
    background: #1f2937; color:#fff;
    transition: transform .06s ease, background .15s ease, box-shadow .15s ease, border-color .15s ease;
    box-shadow: none;
  }
  .exp-btn:active { transform: scale(.985); }
  .exp-btn[disabled] { opacity:.55; cursor:not-allowed; }

  /* === PATRÓN UNIFICADO: BASE OSCURA / HOVER CLARA === */

  /* Iniciar/Abrir (verde turquesa profesional) */
  #btnIniciarAbrir{
    background: linear-gradient(135deg, #0a4d48, #0b5f5a); /* BASE más oscura */
    box-shadow: 0 10px 22px rgba(10,77,72,.35), 0 2px 6px rgba(0,0,0,.28);
    border: 1px solid rgba(9, 83, 77, .65);
  }
  #btnIniciarAbrir:hover{
    background: linear-gradient(135deg, #10a89b, #0f8279); /* HOVER más clara */
    box-shadow: 0 12px 28px rgba(16,168,155,.38), 0 3px 10px rgba(0,0,0,.32);
    border-color: rgba(14,116,144,.6);
  }

  /* Guardar (azul serio) */
  #btnGuardar{
    background: linear-gradient(135deg, #1e3a8a, #1d4ed8); /* BASE más oscura */
    box-shadow: 0 10px 22px rgba(30,64,175,.45), 0 2px 6px rgba(0,0,0,.30);
    border:1px solid rgba(29,78,216,.6);
  }
  #btnGuardar:hover{
    background: linear-gradient(135deg, #2563eb, #3b82f6); /* HOVER más clara */
    box-shadow: 0 12px 28px rgba(37,99,235,.35), 0 3px 10px rgba(0,0,0,.32);
    border-color: rgba(30,58,138,.55);
  }

  /* === Botón flotante “Modificar datos raíz” === */
  #btnEditarRaiz{
    position: fixed; right: 22px; bottom: 22px;
    display: none; /* lo controla el script según si hay expediente */
    padding: 14px 18px;
    border-radius: 12px;
    font-weight: 800;
    letter-spacing: .3px;
    text-decoration: none;
    color: #fff;
    background: linear-gradient(135deg,#1f2937,#334155);
    border: 1px solid rgba(148,163,184,.25);
    box-shadow: 0 10px 24px rgba(2,6,23,.45);
    transition: transform .06s ease, background .15s ease, box-shadow .15s ease;
    z-index: 1000;
  }
  #btnEditarRaiz:hover{
    background: linear-gradient(135deg,#334155,#475569);
    box-shadow: 0 14px 32px rgba(2,6,23,.55);
  }
  #btnEditarRaiz:active{ transform: scale(.985); }
</style>

</head>
<body>
  <header class="site-header">
    <div class="brand">
      <div class="logo"></div>
      <h1>DILIPOL</h1>

      <div class="expediente-bar">
        <div class="expediente-row">
          <button id="btnIniciarAbrir" class="exp-btn primary">Iniciar/Abrir Expediente</button>
          <button id="btnGuardar" class="exp-btn save" style="display:none;">Guardar</button>
          <button id="btnSalir" class="exp-btn warn" style="display:none;">Salir</button>
        </div>
        <input type="file" id="fileExpediente" accept=".json" hidden>
      </div>
    </div>

    <!-- En otras páginas, esta nav sí se muestra -->
    <nav class="top-nav" aria-label="Navegación principal">
      <a href="index.html">Inicio</a>
      <a href="comparecencia.html">COMPARECENCIA</a>
      <a href="diligencias.html">DILIGENCIAS</a>
      <a href="documentos.html">DOCUMENTOS</a>
    </nav>
  </header>

  <main class="container">
    <section class="card hero">
      <div id="homeActions" class="actions">
        <!-- NUEVO: clases por botón para estilos diferenciados -->
        <a class="btn btn--comparecencia" href="comparecencia.html">COMPARECENCIA</a>
        <a class="btn btn--diligencias"   href="diligencias.html">DILIGENCIAS</a>
        <a class="btn btn--documentos"    href="documentos.html">DOCUMENTOS</a>
      </div>
    </section>
  </main>

  <!-- Botón flotante (solo visible con expediente cargado) -->
  <a id="btnEditarRaiz" href="raiz.html" title="Editar campos raíz del expediente">Modificar datos raíz</a>

  <!-- primero cargamos el módulo de guardado-->
  <script src="fs-save.js"></script>

  <script type="module" src="js/router.js"></script>

  <!-- Panel lateral -->
  <div id="panelFiliaciones">
    <!-- Puedes usar estos títulos con las clases de concepto si te encaja en tu UI -->
    <!-- <div class="dili-title">DILIGENCIAS</div> -->
    <!-- <div class="section-title section-title--filiaciones">FILIACIONES</div> -->
    <!-- <div class="section-title section-title--objetos">OBJETOS</div> -->
    <div id="listaFiliaciones"></div>
  </div>

  <script src="js/filiaciones_loader.js"></script>

  <!-- ===== Confirmación de salida (ajustada) ===== -->
  <script>
    (function(){
      const $ = s => document.querySelector(s);
      const btnSalir   = $('#btnSalir');
      const btnGuardar = $('#btnGuardar');
      const btnAbrir   = $('#btnIniciarAbrir');

      function cerrarSesionExpedienteUI(){
        btnGuardar.style.display = 'none';
        btnSalir.style.display   = 'none';
        btnAbrir.style.display   = '';
      }

      function ejecutarGuardar(){
        return new Promise((resolve)=>{
          if (!btnGuardar || btnGuardar.style.display === 'none'){
            return resolve();
          }
          btnGuardar.click();
          setTimeout(resolve, 250);
        });
      }

      // <<< CAMBIADA SOLO ESTA FUNCIÓN >>>
      function confirmarYSalir(){
        const deseaGuardar = confirm('¿Deseas guardar antes de salir?');
        if (deseaGuardar){
          ejecutarGuardar().then(()=>{
            if (window.FS){ FS.setDirty(false); FS.disableGuardOnce(); }
            cerrarSesionExpedienteUI();
            location.href = 'index.html';
          });
        } else {
          if (window.FS){ FS.setDirty(false); FS.disableGuardOnce(); }
          cerrarSesionExpedienteUI();
          location.href = 'index.html';
        }
      }

      if (btnSalir){
        btnSalir.addEventListener('click', (e)=>{
          e.preventDefault();
          confirmarYSalir();
        });
      }

      // Mini-hook: neutralizar el guardián al navegar por la nav superior
      const nav = document.querySelector('.top-nav');
      if (nav){
        nav.addEventListener('click', (e)=>{
          const a = e.target.closest('a[href]');
          if (!a) return;
          if (window.FS){ FS.setDirty(false); FS.disableGuardOnce(); }
          // dejamos seguir la navegación normal
        });
      }

    })();
  </script>

  <!-- === Mostrar/ocultar botón "Modificar datos raíz" según expediente === -->
  <script>
    (function(){
      const btn = document.getElementById('btnEditarRaiz');
      if (!btn) return;

      function refreshBtn(){
        const abierto = localStorage.getItem('expedienteAbierto') === 'true';
        btn.style.display = abierto ? 'inline-flex' : 'none';
      }

      // Inicial
      refreshBtn();

      // Observa cambios de display del panel (lo controla el loader)
      const panel = document.getElementById('panelFiliaciones');
      if (panel && 'MutationObserver' in window) {
        const mo = new MutationObserver(refreshBtn);
        mo.observe(panel, { attributes: true, attributeFilter: ['style','class'] });
      }

      // Reaccionar a acciones típicas
      ['btnIniciarAbrir','btnGuardar','btnSalir'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.addEventListener('click', ()=> setTimeout(refreshBtn, 300));
      });

      // (Opcional) cambios en localStorage desde otra pestaña
      window.addEventListener('storage', (e)=>{
        if (e.key === 'expedienteAbierto') refreshBtn();
      });
    })();
  </script>
</body>
</html>
