<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>COMPAPOL ¬∑ iPhone</title>
<style>
  :root{
    --bg:#0b0820;
    --panel:#120e2a;
    --line:#3b2a7a;
    --txt:#f3e8ff;
    --muted:#c4b5fd;
    --vio:#7c3aed;
    --vio-dk:#5b21b6;
    --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  body{ margin:0; background:var(--bg); color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
  header{ position:sticky; top:0; z-index:9; background:linear-gradient(90deg,var(--vio-dk),#1e1b4b); border-bottom:1px solid var(--line); padding:8px 10px; display:flex; gap:8px; align-items:center; }
  h1{ margin:0; font-size:14px; font-weight:600; }
  .wrap{ padding:10px; max-width:780px; margin:0 auto; }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .btn{ width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--line); background:#1f1140; color:var(--txt); border-radius:10px; font-size:16px; }
  .btn.w{ width:auto; padding:0 10px; height:36px; background:#27135a; }
  textarea{ width:100%; min-height:220px; background:var(--panel); color:var(--txt); border:1px solid var(--line); border-radius:12px; padding:10px; font-size:15px; }
  .status{ font-size:12px; color:var(--muted); min-height:18px; margin:6px 2px 10px; }
  .out{ min-height:160px; background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:10px; }
  .chipbar{ display:flex; gap:6px; overflow-x:auto; padding:6px 0; }
  .chip{ display:inline-flex; align-items:center; gap:6px; padding:4px 6px; background:#1b1146; border:1px solid var(--line); border-radius:999px; font-size:12px; white-space:nowrap; }
  .chip .mini{ width:24px; height:24px; border-radius:8px; border:1px solid var(--line); background:#221155; color:var(--txt); display:inline-flex; align-items:center; justify-content:center; font-size:12px; }
  .accordion{ border:1px solid var(--line); border-radius:12px; overflow:hidden; }
  .acc-h{ background:#1a1440; padding:8px 10px; display:flex; align-items:center; justify-content:space-between; font-size:14px; }
  .acc-c{ background:#120e2a; padding:10px; display:none; }
  .acc-c.show{ display:block; }
  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  input[type="text"],select{ width:100%; height:34px; border-radius:8px; border:1px solid var(--line); background:#0b0820; color:var(--txt); padding:0 8px; font-size:14px; }
  .list{ margin-top:8px; display:grid; gap:6px; }
  .rowItem{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 8px; background:#101237; border:1px solid var(--line); border-radius:10px; font-size:13px; }
  .muted{ color:var(--muted); font-size:12px; }
  .tag{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; background:#221155; border:1px solid var(--line); border-radius:999px; font-size:12px; }
</style>
</head>
<body>
<header>
  <h1>COMPAPOL ¬∑ AWAY</h1>
  <div id="live" class="muted"></div>
</header>
<div class="wrap">

  <!-- Botonera compacta -->
  <div class="row" style="margin-bottom:8px;">
    <button id="btnRec" class="btn" title="Grabar (servidor)">üéß</button>
    <button id="btnRecStop" class="btn" title="Parar grabaci√≥n">‚èπÔ∏è</button>
    <label class="btn" title="Subir audio">
      ‚¨ÜÔ∏è <input id="fileAudio" type="file" accept="audio/*" capture="microphone" style="display:none">
    </label>
    <button id="btnClear" class="btn" title="Limpiar">üßπ</button>
    <button id="btnDraft" class="btn" title="Redactar policial">‚öôÔ∏è</button>
    <button id="btnCopy" class="btn" title="Copiar salida">üìã</button>
    <button id="btnDownload" class="btn" title="Descargar JSON">üíæ</button>
    <button id="btnObj" class="btn" title="Objetos intervenidos">üß≥</button>
  </div>

  <!-- CHIPS de accesos directos (ahora independientes; se pueden borrar sin borrar la ficha) -->
  <div class="chipbar" id="filiChips"></div>

  <!-- Panel OBJETOS -->
  <div class="accordion" id="accObj" style="margin:6px 0 10px;">
    <div class="acc-h">
      <span>Objetos ‚ñæ</span>
      <div class="row">
        <input id="objTxt" type="text" placeholder="A√±adir objeto (p. ej. una cartera)" style="width:200px;">
        <button id="btnObjAdd" class="btn w" title="A√±adir objeto">‚ûï A√±adir</button>
      </div>
    </div>
    <div class="acc-c" id="accObjBody">
      <div class="list" id="objList"></div>
    </div>
  </div>

  <!-- Panel FILIACIONES -->
  <div class="accordion" style="margin:6px 0 10px;">
    <div class="acc-h">
      <span>Filiaciones ‚ñæ</span>
      <div class="row">
        <label class="btn w" for="fileFili" title="Importar JSON">üì• Importar</label>
        <input id="fileFili" type="file" accept="application/json" style="display:none">
        <button id="btnAddFili" class="btn w" title="Guardar ficha">‚ûï A√±adir</button>
      </div>
    </div>
    <div class="acc-c" id="accBody">
      <!-- Campos EXACTOS -->
      <div class="grid2">
        <select id="fiCondicion">
          <option value="">(Condici√≥n)</option>
          <option>denunciado</option>
          <option>investigado</option>
          <option>perjudicado</option>
          <option>requirente</option>
          <option>testigo</option>
        </select>
        <select id="fiSexo">
          <option value="">(Sexo)</option>
          <option>Masculino</option>
          <option>Femenino</option>
        </select>

        <input id="fiNombre" type="text" placeholder="Nombre">
        <input id="fiApellidos" type="text" placeholder="Apellidos (MAY√öSC.)">

        <input id="fiNacionalidad" type="text" placeholder="Nacionalidad">
        <input id="fiTipoDoc" type="text" placeholder="Tipo de documento (DNI/NIE/PAS‚Ä¶)">

        <input id="fiNumDoc" type="text" placeholder="N¬∫ Documento">
        <input id="fiFechaNac" type="text" placeholder="Fecha de nacimiento (libre)">

        <input id="fiLugarNac" type="text" placeholder="Lugar de nacimiento">
        <input id="fiPadres" type="text" placeholder="Nombre de los Padres">

        <input id="fiDom" type="text" placeholder="Domicilio">
        <input id="fiTel" type="text" placeholder="Tel√©fono">
      </div>

      <div class="muted" style="margin-top:6px;">Las fichas se guardan en este dispositivo.</div>
      <div class="list" id="filiList"></div>
    </div>
  </div>

  <!-- √Årea de dictado (sin placeholder) -->
  <textarea id="txt"></textarea>
  <div id="status" class="status"></div>

  <h3 style="margin:10px 0 6px;">Salida</h3>
  <div id="out" class="out" contenteditable="true"></div>
</div>

<script>
/* ==================== CONFIG ==================== */
const API_BASE = "https://compa-movil-backend.onrender.com";

/* ==================== UTIL / ESTADO ==================== */
const $ = s => document.querySelector(s);
const live = $('#live'), statusEl = $('#status'), txt = $('#txt'), out = $('#out');
function setStatus(s){ statusEl.textContent = s; }
function setLive(s){ live.textContent = s; }

/* ==================== STORAGE ==================== */
const LSK_MAP = "compapol.fili.map";       // mapa de fichas { id: {...} }
const LSK_SHORT = "compapol.fili.shortcuts"; // lista de ids con chip visible
const LSK_OBJS = "compapol.objects";       // array de strings

function loadMap(){ try{ const v=JSON.parse(localStorage.getItem(LSK_MAP)||"{}"); return v&&typeof v==="object"?v:{}; }catch{ return {}; } }
function saveMap(m){ localStorage.setItem(LSK_MAP, JSON.stringify(m||{})); }
function loadShort(){ try{ const v=JSON.parse(localStorage.getItem(LSK_SHORT)||"[]"); return Array.isArray(v)?v:[]; }catch{ return []; } }
function saveShort(a){ localStorage.setItem(LSK_SHORT, JSON.stringify(Array.isArray(a)?a:[])); }
function loadObjs(){ try{ const v=JSON.parse(localStorage.getItem(LSK_OBJS)||"[]"); return Array.isArray(v)?v:[]; }catch{ return []; } }
function saveObjs(a){ localStorage.setItem(LSK_OBJS, JSON.stringify(Array.isArray(a)?a:[])); }

/* ==================== INSERCI√ìN EN CURSOR ==================== */
function insertAtCursor(el, text){
  const start = el.selectionStart ?? el.value.length;
  const end = el.selectionEnd ?? el.value.length;
  const before = el.value.slice(0,start);
  const after  = el.value.slice(end);
  el.value = before + text + after;
  const pos = start + text.length;
  el.selectionStart = el.selectionEnd = pos;
  el.focus();
}
function insertHtmlAtCursorInContentEditable(container, html) {
  container.focus();
  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) { container.insertAdjacentHTML('beforeend', html); return; }
  const range = sel.getRangeAt(0);
  const temp = document.createElement('div'); temp.innerHTML = html;
  const frag = document.createDocumentFragment(); let node;
  while ((node = temp.firstChild)) frag.appendChild(node);
  range.deleteContents(); range.insertNode(frag);
  sel.removeAllRanges(); const r = document.createRange(); r.selectNodeContents(container); r.collapse(false); sel.addRange(r);
}

/* ==================== FORMATO DE FICHA ==================== */
function formatFichaFull(x){
  const nom=(x.nombre||"").trim(), ape=(x.apellidos||"").trim();
  if(!nom && !ape) return "";
  const segs=[];
  segs.push([nom.toUpperCase(), ape.toUpperCase()].filter(Boolean).join(" ").trim());

  const tipo=(x.tipo_doc||"").trim(), num=(x.num_doc||"").trim();
  if (tipo && num) segs.push(`${tipo} ${num}`);
  else if (tipo && !num) segs.push(tipo);
  else if (!tipo && num) segs.push(num);
  else segs.push("indocumentado/a");

  const sx=(x.sexo||"").toLowerCase();
  const nac = sx.startsWith("f") ? "nacida" : sx.startsWith("m") ? "nacido" : "nacido/a";
  const lugar=(x.lugar_nacimiento||"").trim();
  const f=(x.fecha_nacimiento||"").trim();
  const segNac=[]; if(lugar) segNac.push(`en ${lugar}`); if(f) segNac.push(`el ${f}`);
  if (segNac.length) segs.push(`${nac} ${segNac.join(" ")}`);

  if (x.padres && x.padres.trim()){
    const hijo = sx.startsWith("f") ? "hija" : sx.startsWith("m") ? "hijo" : "hijo/a";
    segs.push(`${hijo} de ${x.padres.trim()}`);
  }
  if (x.domicilio && x.domicilio.trim()) segs.push(`domicilio en ${x.domicilio.trim()}`);
  if (x.telefono && x.telefono.trim()) segs.push(`tel√©fono ${x.telefono.trim()}`);
  return segs.join(", ")+".";
}

/* ==================== UI: CHIPS / LISTAS ==================== */
const chips = $('#filiChips');
const list  = $('#filiList');
const accBody = $('#accBody');

function chipLabel(v){
  const n = [ (v.nombre||"").trim(), (v.apellidos||"").trim() ].filter(Boolean).join(" ");
  return n ? (n.length>14 ? n.slice(0,14)+"‚Ä¶" : n) : "sin nombre";
}

function rebuildChips(){
  const m = loadMap();
  const shortcuts = loadShort().filter(id => m[id]); // solo los que existan
  chips.innerHTML = "";
  for (const id of shortcuts){
    const v = m[id];
    const d=document.createElement('div'); d.className='chip';
    const s=document.createElement('span'); s.textContent=chipLabel(v);

    const bT=document.createElement('button'); bT.className='mini'; bT.textContent='‚ûïT'; bT.title='Insertar en TEXTO';
    bT.onclick=()=>{ const t=formatFichaFull(v); if(t) insertAtCursor(txt, t+" "); };

    const bR=document.createElement('button'); bR.className='mini'; bR.textContent='‚ûïR'; bR.title='Insertar en REDACCI√ìN';
    bR.onclick=()=>{ const t=formatFichaFull(v); if(t) insertHtmlAtCursorInContentEditable(out, `<p>‚Äî Que ${t}</p>`); };

    const bHide=document.createElement('button'); bHide.className='mini'; bHide.textContent='‚úñÔ∏è'; bHide.title='Quitar acceso directo';
    bHide.onclick=()=>{ const cur = loadShort().filter(x=>x!==id); saveShort(cur); rebuildChips(); setStatus('‚úñÔ∏è Acceso directo eliminado (la ficha sigue en el panel).'); };

    d.appendChild(s); d.appendChild(bT); d.appendChild(bR); d.appendChild(bHide);
    chips.appendChild(d);
  }
}

function rebuildFiliList(){
  const m = loadMap();
  const shortcuts = new Set(loadShort());
  list.innerHTML = "";
  for (const [id,v] of Object.entries(m)){
    const row=document.createElement('div'); row.className='rowItem';
    const l=document.createElement('div');
    const display = [ (v.nombre||"").toUpperCase(), (v.apellidos||"").toUpperCase() ].filter(Boolean).join(" ").trim();
    l.textContent = display || id;

    const r=document.createElement('div');
    const b1=document.createElement('button'); b1.className='btn w'; b1.textContent='‚ûïT';
    b1.onclick=()=>{ const t=formatFichaFull(v); if(t) insertAtCursor(txt, t+" "); };

    const b2=document.createElement('button'); b2.className='btn w'; b2.textContent='‚ûïR';
    b2.onclick=()=>{ const t=formatFichaFull(v); if(t) insertHtmlAtCursorInContentEditable(out, `<p>‚Äî Que ${t}</p>`); };

    const b3=document.createElement('button'); b3.className='btn w'; b3.textContent= shortcuts.has(id) ? 'Ocultar chip' : 'Crear chip';
    b3.onclick=()=>{
      let cur = loadShort();
      if (shortcuts.has(id)) { cur = cur.filter(x=>x!==id); }
      else { cur.push(id); }
      saveShort(cur); rebuildChips(); rebuildFiliList();
    };

    const bDel=document.createElement('button'); bDel.className='btn w'; bDel.textContent='üóëÔ∏è';
    bDel.onclick=()=>{ const mm = loadMap(); delete mm[id]; saveMap(mm); let sc=loadShort().filter(x=>x!==id); saveShort(sc); rebuildChips(); rebuildFiliList(); setStatus('üóëÔ∏è Ficha eliminada.'); };

    r.appendChild(b1); r.appendChild(b2); r.appendChild(b3); r.appendChild(bDel);
    row.appendChild(l); row.appendChild(r);
    list.appendChild(row);
  }
}

function rebuildUI(){ rebuildChips(); rebuildFiliList(); }

/* ==================== OBJETOS ==================== */
const accObj = $('#accObj'), accObjBody = $('#accObjBody'), objList = $('#objList'), objTxt = $('#objTxt');

function rebuildObjs(){
  const arr = loadObjs();
  objList.innerHTML = "";
  arr.forEach((it, idx)=>{
    const row=document.createElement('div'); row.className='rowItem';
    const left=document.createElement('div'); left.textContent = it;
    const right=document.createElement('div');
    const del=document.createElement('button'); del.className='btn w'; del.textContent='üóëÔ∏è';
    del.onclick=()=>{ const a=loadObjs(); a.splice(idx,1); saveObjs(a); rebuildObjs(); setStatus('üóëÔ∏è Objeto eliminado.'); };
    right.appendChild(del);
    row.appendChild(left); row.appendChild(right);
    objList.appendChild(row);
  });
}
rebuildObjs();

$('#btnObj').addEventListener('click', ()=>{ accObjBody.classList.toggle('show'); });
$('#btnObjAdd').addEventListener('click', ()=>{
  const t=(objTxt.value||"").trim(); if(!t) return;
  const a=loadObjs(); a.push(t); saveObjs(a); objTxt.value=""; rebuildObjs(); setStatus('‚úÖ Objeto a√±adido.');
});

/* ==================== PLEGABLES ==================== */
document.querySelectorAll('.acc-h').forEach(h=>{
  h.addEventListener('click', (e)=>{
    const wrap = h.parentElement;
    const body = wrap.querySelector('.acc-c');
    // evita plegar si se ha pulsado un control de cabecera
    if (e.target.id==='btnObjAdd' || e.target.id==='objTxt' || e.target.id==='btnAddFili' || e.target.htmlFor==='fileFili') return;
    body.classList.toggle('show');
  });
});

/* ==================== FORM / IMPORT ==================== */
const fiCondicion=$('#fiCondicion'), fiSexo=$('#fiSexo'), fiNombre=$('#fiNombre'), fiApellidos=$('#fiApellidos'),
      fiNacionalidad=$('#fiNacionalidad'), fiTipoDoc=$('#fiTipoDoc'), fiNumDoc=$('#fiNumDoc'),
      fiFechaNac=$('#fiFechaNac'), fiLugarNac=$('#fiLugarNac'), fiPadres=$('#fiPadres'),
      fiDom=$('#fiDom'), fiTel=$('#fiTel');

function toInternalFromSpanish(obj){
  return {
    condicion: obj["Condici√≥n"] ?? obj["condicion"] ?? "",
    sexo: obj["Sexo"] ?? obj["sexo"] ?? "",
    nombre: obj["Nombre"] ?? obj["nombre"] ?? "",
    apellidos: obj["Apellidos"] ?? obj["apellidos"] ?? "",
    nacionalidad: obj["Nacionalidad"] ?? obj["nacionalidad"] ?? "",
    tipo_doc: obj["Tipo de documento"] ?? obj["tipo_doc"] ?? obj["tipoDocumento"] ?? "",
    num_doc: obj["N¬∫ Documento"] ?? obj["numeroDocumento"] ?? obj["num_doc"] ?? obj["N¬∫ documento"] ?? obj["N¬∫"] ?? "",
    fecha_nacimiento: obj["Fecha de nacimiento"] ?? obj["fecha_nacimiento"] ?? "",
    lugar_nacimiento: obj["Lugar de nacimiento"] ?? obj["lugar_nacimiento"] ?? "",
    padres: obj["Nombre de los Padres"] ?? obj["padres"] ?? "",
    domicilio: obj["Domicilio"] ?? obj["domicilio"] ?? "",
    telefono: obj["Tel√©fono"] ?? obj["telefono"] ?? ""
  };
}

function toSpanishFromInternal(v){
  return {
    "Condici√≥n": v.condicion || "",
    "Sexo": v.sexo || "",
    "Nombre": v.nombre || "",
    "Apellidos": v.apellidos || "",
    "Nacionalidad": v.nacionalidad || "",
    "Tipo de documento": v.tipo_doc || "",
    "N¬∫ Documento": v.num_doc || "",
    "Fecha de nacimiento": v.fecha_nacimiento || "",
    "Lugar de nacimiento": v.lugar_nacimiento || "",
    "Nombre de los Padres": v.padres || "",
    "Domicilio": v.domicilio || "",
    "Tel√©fono": v.telefono || ""
  };
}

$('#btnAddFili').addEventListener('click', ()=>{
  const id = "P"+Date.now();
  const v = {
    condicion: fiCondicion.value||"",
    sexo: fiSexo.value||"",
    nombre: fiNombre.value||"",
    apellidos: fiApellidos.value||"",
    nacionalidad: fiNacionalidad.value||"",
    tipo_doc: fiTipoDoc.value||"",
    num_doc: fiNumDoc.value||"",
    fecha_nacimiento: fiFechaNac.value||"",
    lugar_nacimiento: fiLugarNac.value||"",
    padres: fiPadres.value||"",
    domicilio: fiDom.value||"",
    telefono: fiTel.value||""
  };
  const m = loadMap(); m[id]=v; saveMap(m);
  // A√±ade atajo por defecto
  const sc = loadShort(); sc.push(id); saveShort(sc);
  fiCondicion.value=fiSexo.value=fiNombre.value=fiApellidos.value=fiNacionalidad.value=fiTipoDoc.value=fiNumDoc.value=fiFechaNac.value=fiLugarNac.value=fiPadres.value=fiDom.value=fiTel.value="";
  rebuildUI();
  setStatus("‚úÖ Ficha guardada (y acceso directo creado).");
});

// Importar JSON ‚Äî ACEPTA:
// 1) { doc, filiaciones:[ {...}, {...} ], objects:[...] }
// 2) { id:{...}, id2:{...} }  (objeto plano de varias fichas)
// 3) [ {...}, {...} ]         (array de fichas)
// 4) { "Condici√≥n": "...", ... } (una sola ficha)
$('#fileFili').addEventListener('change', async (ev)=>{
  const f = ev.target.files?.[0]; if(!f) return;
  try{
    const txtJ = await f.text();
    const obj = JSON.parse(txtJ);
    const m = loadMap(); let sc = loadShort();

    const addOne = (raw) => {
      const v = toInternalFromSpanish(raw);
      const hasSome = Object.values(v).some(x => (x||"").toString().trim().length);
      if (!hasSome) return;
      const id = "P"+Date.now()+Math.floor(Math.random()*1000);
      m[id] = v;
      if (!sc.includes(id)) sc.push(id); // crea acceso directo por defecto
    };

    if (Array.isArray(obj)) {
      for (const it of obj) if (it && typeof it==="object") addOne(it);
    } else if (obj && typeof obj==="object") {
      if (typeof obj.doc === "string") out.innerHTML = obj.doc;
      if (Array.isArray(obj.objects)) { saveObjs(obj.objects.slice()); rebuildObjs(); }

      if (Array.isArray(obj.filiaciones)) {
        for (const val of obj.filiaciones) if (val && typeof val==="object") addOne(val);
      } else {
        const keys = Object.keys(obj);
        const labelKeys = ["Condici√≥n","Sexo","Nombre","Apellidos","Nacionalidad","Tipo de documento","N¬∫ Documento","Fecha de nacimiento","Lugar de nacimiento","Nombre de los Padres","Domicilio","Tel√©fono"];
        const isSingle = labelKeys.some(k => k in obj) || labelKeys.some(k => k.toLowerCase() in Object.fromEntries(keys.map(k=>[k.toLowerCase(),true])));
        if (isSingle) {
          addOne(obj);
        } else {
          for (const val of Object.values(obj)) if (val && typeof val==="object") addOne(val);
        }
      }
    } else {
      throw new Error("Formato JSON no v√°lido");
    }

    saveMap(m); saveShort(sc);
    rebuildUI();
    setStatus("‚úÖ Datos importados.");
  }catch(e){
    setStatus("‚ùå Error al importar: "+(e.message||e));
  }finally{
    ev.target.value="";
  }
});

/* ==================== AUDIO (iPhone-friendly) ==================== */
const btnRec = $('#btnRec'), btnRecStop = $('#btnRecStop'), fileAudio = $('#fileAudio');

let mediaRecorder=null, recChunks=[], recStream=null;
async function startRecording(){
  try{
    recStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    let mime=''; if (window.MediaRecorder && MediaRecorder.isTypeSupported){
      if (MediaRecorder.isTypeSupported('audio/mp4')) mime='audio/mp4';
      else if (MediaRecorder.isTypeSupported('audio/webm')) mime='audio/webm';
    }
    mediaRecorder = mime ? new MediaRecorder(recStream,{mimeType:mime}) : new MediaRecorder(recStream);
    recChunks=[];
    mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size) recChunks.push(e.data); };
    mediaRecorder.onstart = ()=> setStatus('üî¥ Grabando‚Ä¶');
    mediaRecorder.onstop = async ()=>{
      try{
        const type = mediaRecorder.mimeType || (recChunks[0]?.type) || 'audio/mp4';
        const blob = new Blob(recChunks,{type});
        const ext = type.includes('mp4')?'m4a':type.includes('webm')?'webm':type.includes('wav')?'wav':'m4a';
        const file = new File([blob],`grabacion.${ext}`,{type});
        setStatus('‚è≥ Enviando audio‚Ä¶');
        const fd = new FormData(); fd.append('file',file,file.name);
        const r = await fetch(`${API_BASE}/api/whisper`,{method:'POST', body:fd});
        if(!r.ok){ let msg='HTTP '+r.status; try{const j=await r.json(); if(j?.error) msg+=' ¬∑ '+j.error;}catch{} throw new Error(msg); }
        const { text } = await r.json();
        txt.value = (txt.value ? (txt.value.trim()+" ") : "") + (text||"");
        setStatus('‚úÖ Transcripci√≥n lista.');
      }catch(e){ setStatus('‚ùå Error: '+(e.message||e)); }
      finally{ recStream?.getTracks()?.forEach(t=>t.stop()); recStream=null; mediaRecorder=null; recChunks=[]; }
    };
    mediaRecorder.start(1000);
  }catch(err){ setStatus('‚ùå Micr√≥fono no disponible: '+(err.message||err)); }
}
function stopRecording(){ try{ if(mediaRecorder && mediaRecorder.state!=='inactive') mediaRecorder.stop(); }catch{} }
btnRec.addEventListener('click', startRecording);
btnRecStop.addEventListener('click', stopRecording);

// Subir audio manual
fileAudio.addEventListener('change', async ()=>{
  const f = fileAudio.files?.[0]; if(!f) return;
  try{
    setStatus('‚è≥ Transcribiendo‚Ä¶');
    const fd = new FormData(); fd.append('file',f,f.name);
    const r = await fetch(`${API_BASE}/api/whisper`,{method:'POST', body:fd});
    if(!r.ok){ let msg='HTTP '+r.status; try{const j=await r.json(); if(j?.error) msg+=' ¬∑ '+j.error;}catch{} throw new Error(msg); }
    const { text } = await r.json();
    txt.value = (txt.value ? (txt.value.trim()+" ") : "") + (text||"");
    setStatus('‚úÖ Transcripci√≥n lista.');
  }catch(e){ setStatus('‚ùå Error: '+(e.message||e)); }
  finally{ fileAudio.value=''; }
});

/* ==================== REDACTAR / LIMPIAR / COPIAR / DESCARGAR ==================== */
$('#btnDraft').addEventListener('click', async ()=>{
  const body = JSON.stringify({ texto: txt.value||"", filiaciones:[], objetos:loadObjs(), fichas_resueltas:[] });
  try{
    setStatus('‚è≥ Redactando comparecencia‚Ä¶');
    const r = await fetch(`${API_BASE}/api/police-draft`, { method:'POST', headers:{'Content-Type':'application/json'}, body });
    if(!r.ok){ let msg='HTTP '+r.status; try{const j=await r.json(); if(j?.error) msg+=' ¬∑ '+j.error;}catch{} throw new Error(msg); }
    const { html } = await r.json();
    out.innerHTML = html || '';
    setStatus('‚úÖ Listo.');
  }catch(e){ setStatus('‚ùå Error en redacci√≥n: '+(e.message||e)); }
});

$('#btnClear').addEventListener('click', ()=>{ txt.value=''; out.innerHTML=''; setStatus('üßπ Limpio.'); });

$('#btnCopy').addEventListener('click', async ()=>{
  try{
    const plain = (out.innerHTML||'').replace(/<p>/g,'\n').replace(/<[^>]+>/g,'').trim();
    await navigator.clipboard.writeText(plain);
    setStatus('üìã Copiado (texto plano).');
  }catch{ setStatus('‚ö†Ô∏è No se pudo copiar.'); }
});

// Descargar JSON principal: { doc, filiaciones:[...], objects:[...] }
$('#btnDownload').addEventListener('click', ()=>{
  const m = loadMap();
  const arr = Object.values(m).map(toSpanishFromInternal); // array con etiquetas en espa√±ol
  const payload = {
    doc: out.innerHTML || "",
    filiaciones: arr,
    objects: loadObjs()
  };
  // nombre compa_HHMM.json
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const fname = `compa_${hh}${mm}.json`;

  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fname;
  a.click();
  setStatus(`üíæ JSON descargado (${fname}).`);
});

/* ==================== PING ==================== */
(async()=>{ try{ const r=await fetch(`${API_BASE}/healthz`); setLive(r.ok?'üü¢':'üü†'); }catch{ setLive('üü†'); }})();

/* ==================== INIT ==================== */
rebuildUI();
</script>
</body>
</html>
